# .github/workflows/daily-etl.yml
# Run the Land Registry TXT ETL daily (and manually if needed)
# - Uses Python 3.11
# - Passes multi-line GCP_SA_JSON via env (do NOT use echo >> $GITHUB_ENV for multi-line secrets)
# - Installs dependencies and runs etl/etl_main.py

name: Daily Land Registry ETL

on:
  schedule:
    - cron: '0 2 * * *'   # daily at 02:00 UTC
  workflow_dispatch:      # allow manual trigger

jobs:
  run-etl:
    runs-on: ubuntu-latest

    steps:
      # 1) Check out repository so the workflow can access files
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2) Set up Python 3.11 for the runner
      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3) Install dependencies needed by the ETL script
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests google-api-python-client google-auth

      # 4) Run the ETL script
      - name: Run ETL script (Land Registry TXT -> Google Sheets)
        # Pass secrets as environment variables directly to the step (handles multi-line JSON)
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
          GCP_SA_JSON: ${{ secrets.GCP_SA_JSON }}
          # Optional: HMLR_API_KEY can remain in secrets but is not required for TXT download
          HMLR_API_KEY: ${{ secrets.HMLR_API_KEY }}
        run: |
          # Increase default timeout for Python if needed (the runner step itself has a default 6 hour job timeout)
          python etl/etl_main.py
